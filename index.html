<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nexus Web IA • Sci‑Fi HUD</title>
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    /* ==================== THEME ==================== */
    :root{
      --bg:#04050b; --ink:#eef0ff; --mut:#b3b6e6; --line:#2a2f5a;
      --brand:#00e5ff; --brand2:#7b5cff; --brand3:#00ffbf; --danger:#ff5577; --ok:#00ffa3;
      --glass:rgba(12,12,30,.55); --card:rgba(14,18,42,.65); --chip:rgba(22,26,58,.7);
      --shadow:0 20px 60px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; color:var(--ink); background:var(--bg); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; overflow:hidden}

    /* ==================== FX LAYERS ==================== */
    .fx, .grid, .scan{position:fixed; inset:0; pointer-events:none}
    .fx{z-index:-3; filter:blur(50px); opacity:.6;
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(0,229,255,.18), transparent 60%),
        radial-gradient(1000px 700px at 10% -20%, rgba(123,92,255,.18), transparent 55%),
        radial-gradient(900px 600px at 50% 110%, rgba(0,255,191,.18), transparent 60%);
      animation:float 20s ease-in-out infinite alternate}
    .grid{z-index:-2; opacity:.35; background:
        linear-gradient(transparent 95%, rgba(123,92,255,.15) 96%),
        linear-gradient(90deg, transparent 95%, rgba(0,229,255,.12) 96%);
      background-size: 36px 36px; mask-image:radial-gradient(80% 70% at 50% 40%, #000 60%, transparent 100%)}
    .scan{z-index:-1; background:linear-gradient(0deg, rgba(255,255,255,0), rgba(255,255,255,.06), rgba(255,255,255,0)); animation:scan 7s linear infinite}
    @keyframes float{to{transform:translateY(8%) scale(1.05)}}
    @keyframes scan{0%{transform:translateY(-100%)}100%{transform:translateY(100%)}}
    @keyframes glow{0%,100%{box-shadow:0 0 0 rgba(0,229,255,0)}50%{box-shadow:0 0 32px rgba(0,229,255,.35)}}

    /* ==================== LAYOUT ==================== */
    .app{display:grid; grid-template-columns: 340px 1fr; height:100vh}
    .sidebar{border-right:1px solid var(--line); padding:18px; display:flex; flex-direction:column; gap:16px; backdrop-filter: blur(10px); background:linear-gradient(180deg, rgba(12,14,36,.7), rgba(8,10,24,.9))}

    /* Header/Brand */
    .brand{display:flex; align-items:center; gap:14px; padding:14px; border-radius:16px; background:var(--glass); border:1px solid rgba(0,229,255,.3); box-shadow:var(--shadow)}
    .badge{width:44px;height:44px;border-radius:14px; position:relative; background:conic-gradient(from 220deg, var(--brand), var(--brand2), var(--brand3), var(--brand)); border:1px solid rgba(255,255,255,.15)}
    .badge:after{content:""; position:absolute; inset:6px; border-radius:10px; background:radial-gradient(circle at 30% 30%, #fff, #bdf, transparent 70%); opacity:.55}
    .brand h1{margin:0; font:800 18px Oxanium, Inter; letter-spacing:.5px}
    .sub{font:600 10px Inter; color:#cbd0ff; padding:3px 8px; border-radius:999px; border:1px solid rgba(123,92,255,.35); background:linear-gradient(135deg, rgba(0,229,255,.14), rgba(123,92,255,.14))}

    /* Cards */
    .panel{border:1px solid rgba(123,92,255,.25); border-radius:18px; background:var(--card); box-shadow:var(--shadow); padding:14px}
    .panel h2{margin:0 0 10px; font:700 11px Oxanium; text-transform:uppercase; letter-spacing:.22em; color:#dfe2ff}

    .capability{display:flex; align-items:center; justify-content:space-between; padding:10px; border-radius:12px; background:var(--chip); border:1px solid rgba(123,92,255,.28); margin-bottom:8px}
    .capability label{display:flex; align-items:center; gap:10px; cursor:pointer}
    .capability svg{width:18px;height:18px; opacity:.9}

    .switch{appearance:none; width:50px;height:28px;background:#232751;border-radius:999px; position:relative; outline:none; cursor:pointer; transition:.2s; border:1px solid rgba(0,229,255,.35)}
    .switch:before{content:""; width:20px;height:20px; background:radial-gradient(circle at 30% 30%, #fff, #dff); border-radius:50%; position:absolute; top:3px; left:3px; transition:.2s}
    .switch:checked{background:linear-gradient(135deg, var(--brand), var(--brand2))}
    .switch:checked:before{left:27px}

    .range{display:flex; gap:10px}
    .field{display:grid; gap:6px; margin-bottom:10px}
    .field label{font-size:12px; color:#c9ccee}
    .field input, .field select{padding:10px 12px; border-radius:12px; border:1px solid rgba(123,92,255,.28); background:#0f1234; color:#fff}

    .btn{border:1px solid rgba(123,92,255,.35); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); color:var(--ink); padding:10px 12px; border-radius:12px; cursor:pointer; transition:.15s}
    .btn:hover{filter:brightness(1.12); box-shadow:0 0 22px rgba(0,229,255,.18)}

    .main{display:grid; grid-template-rows: auto auto 1fr auto; min-width:0}
    .topbar{display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)); backdrop-filter: blur(6px)}
    .title{display:flex; align-items:center; gap:12px}
    .title h3{margin:0; font:800 15px Oxanium; letter-spacing:.4px}
    .chip{padding:6px 10px; border-radius:999px; background:rgba(0,229,255,.2); border:1px solid rgba(0,229,255,.4); color:#e6fcff; font:700 11px Inter}

    .quick{padding:12px 20px; display:flex; flex-wrap:wrap; gap:10px; border-bottom:1px solid var(--line)}
    .quick .q{padding:9px 12px; background:var(--chip); border:1px solid rgba(123,92,255,.3); border-radius:999px; cursor:pointer; font:700 12px Inter; color:#e7eaff}
    .quick .q:hover{box-shadow:0 0 18px rgba(0,229,255,.24)}

    .chat{padding:22px 20px; overflow:auto; position:relative}
    .msg{display:grid; grid-template-columns: 46px 1fr; gap:12px; margin-bottom:16px}
    .avatar{width:46px;height:46px; border-radius:14px; background:linear-gradient(135deg, var(--brand), var(--brand2)); display:grid; place-items:center; font:800 14px Oxanium; color:#06101a; border:1px solid rgba(255,255,255,.15)}
    .avatar.user{background:#222657; color:#cfd1ff}
    .bubble{position:relative; background:var(--card); border:1px solid rgba(0,229,255,.35); padding:16px; border-radius:16px; box-shadow:var(--shadow); backdrop-filter:blur(6px)}
    .bubble::after{content:""; position:absolute; inset:-1px; border-radius:16px; padding:1px; background:linear-gradient(135deg, rgba(0,229,255,.5), rgba(123,92,255,.45)); -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite:xor; mask-composite: exclude; opacity:.35}
    .bubble p{margin:0 0 10px; line-height:1.6}
    .bubble pre{background:#0e1234; color:#E9E7FF; border:1px solid #2a2a57; padding:12px; border-radius:12px; overflow:auto}
    .bubble code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}

    .status{position:sticky; top:0; z-index:5; margin-bottom:8px}
    .banner{display:none; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.2)}
    .banner.show{display:flex; align-items:center; gap:8px}
    .banner.ok{background:rgba(0,255,191,.12); border-color:rgba(0,255,191,.35)}
    .banner.err{background:rgba(255,85,119,.12); border-color:rgba(255,85,119,.35)}

    .web-results{display:grid; gap:10px; margin-top:10px}
    .result{background:#0e133a; border:1px solid rgba(123,92,255,.35); padding:12px; border-radius:12px}
    .result h4{margin:0 0 6px; font:700 13px Oxanium}
    .result .meta{font-size:11px; color:#b9b6d1}
    .result .snippet{font-size:13px; color:#e9e7ff; opacity:.92; margin-top:6px}

    .composer{border-top:1px solid var(--line); padding:16px 20px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)); backdrop-filter: blur(6px)}
    .composer form{display:grid; grid-template-columns: 1fr auto; gap:10px}
    .input-wrap{display:grid; gap:10px}
    .row{display:flex; gap:10px; align-items:center}
    .textarea{min-height:56px; max-height:220px; resize:vertical; width:100%; padding:14px; border-radius:14px; border:1px solid rgba(0,229,255,.35); background:rgba(10,12,34,.75); color:var(--ink); box-shadow:inset 0 0 0 1px rgba(0,229,255,.08)}
    .subinput{flex:1; padding:11px 12px; border-radius:12px; border:1px dashed rgba(123,92,255,.35); background:#0f1030; color:#d7d5ea}
    .secondary{display:flex; gap:10px}
    .iconbtn{width:46px;height:46px; border-radius:14px; display:grid; place-items:center; border:1px solid rgba(123,92,255,.35); background:var(--chip); cursor:pointer; transition:.15s}
    .iconbtn:hover{box-shadow:0 0 18px rgba(0,229,255,.28)}
    .send{padding:0 22px; border-radius:14px; border:1px solid rgba(0,229,255,.45); background:linear-gradient(135deg, var(--brand), var(--brand2)); color:#0a0820; font:800 13px Oxanium; letter-spacing:.4px; text-transform:uppercase; animation:glow 3.6s ease-in-out infinite}

    .drop{border:1px dashed rgba(123,92,255,.45); border-radius:14px; padding:12px; text-align:center; color:#bdbbe0; font-size:12px; background:rgba(16,16,40,.35)}

    .typing{display:inline-flex; gap:4px; align-items:center; margin-left:4px}
    .dot{width:6px;height:6px;border-radius:50%;background:#9fb6ff; opacity:.6; animation:b 1.2s infinite}
    .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
    @keyframes b{0%,100%{transform:translateY(0);opacity:.4}50%{transform:translateY(-3px);opacity:1}}

    @media (max-width:1024px){ .app{grid-template-columns: 1fr} .sidebar{display:none} }
  </style>
</head>
<body>
  <div class="fx"></div><div class="grid"></div><div class="scan"></div>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="badge"></div>
        <div>
          <h1>Nexus Web IA</h1>
          <span class="sub">interface de IA com acesso total</span>
        </div>
      </div>

      <div class="panel">
        <h2>Recursos</h2>
        <div class="capability"><label for="cap-web">🌐 Acesso à Web</label><input id="cap-web" class="switch" type="checkbox" checked></div>
        <div class="capability"><label for="cap-news">🗞️ Notícias recentes</label><input id="cap-news" class="switch" type="checkbox"></div>
        <div class="capability"><label for="cap-wiki">📚 Wikipedia + Web</label><input id="cap-wiki" class="switch" type="checkbox" checked></div>
        <div class="capability"><label for="cap-youtube">▶️ YouTube (transcrições)</label><input id="cap-youtube" class="switch" type="checkbox"></div>
        <div class="capability"><label for="cap-files">📄 PDFs / Arquivos</label><input id="cap-files" class="switch" type="checkbox"></div>
        <div class="capability"><label for="cap-sheets">🧮 Google Sheets</label><input id="cap-sheets" class="switch" type="checkbox"></div>
      </div>

      <div class="panel">
        <h2>Parâmetros</h2>
        <div class="field"><label for="max-web">Máx. resultados web</label><input id="max-web" type="number" min="1" max="12" value="6"/></div>
        <div class="field"><label for="web-depth">Profundidade de busca</label>
          <select id="web-depth"><option value="fast">Rápida</option><option value="balanced" selected>Equilibrada</option><option value="deep">Profunda</option></select>
        </div>
      </div>

      <div class="panel">
        <h2>Utilidades</h2>
        <div class="range" style="gap:10px"><button class="btn" id="btn-settings">Configurações</button><button class="btn" id="btn-clear">Limpar</button></div>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="title"><span class="chip" id="status-chip">Verificando servidor…</span><h3>Nexus Web • Sci‑Fi HUD</h3></div>
        <div class="range"><button class="btn" id="btn-export">Exportar</button><button class="btn" id="btn-tts">Ler resposta</button></div>
      </header>

      <section class="quick" id="quick">
        <button class="q" data-template="Pesquise o panorama mais recente sobre {tema}, cite 5 fontes confiáveis e a data de publicação.">Panorama + 5 fontes</button>
        <button class="q" data-template="Leia e resuma criticamente a página: {url}. Traga citações e trechos importantes com as respectivas fontes.">Resumo de página</button>
        <button class="q" data-template="Extraia os principais tópicos do vídeo {urlYouTube} e crie um resumo com timestamps.">Resumo de vídeo</button>
        <button class="q" data-template="Compare as últimas notícias sobre {assunto} em 3 veículos diferentes e aponte divergências.">Comparar notícias</button>
        <button class="q" data-template="Liste prós e contras de {produto/serviço} com base em reviews recentes e documentação oficial.">Prós × Contras</button>
      </section>

      <section class="chat" id="chat" aria-live="polite">
        <div class="status">
          <div id="banner-ok" class="banner ok"></div>
          <div id="banner-err" class="banner err"></div>
        </div>
      </section>

      <footer class="composer">
        <form id="ask-form">
          <div class="input-wrap">
            <textarea id="prompt" class="textarea" placeholder="Pergunte qualquer coisa… (use / para comandos)" required></textarea>
            <div class="row">
              <input id="page-url" class="subinput" placeholder="URL opcional para a IA ler (site, PDF ou vídeo)" />
              <div class="secondary">
                <label class="iconbtn" title="Falar" id="btn-mic" aria-label="Gravar voz">🎙️</label>
                <label class="iconbtn" title="Anexar arquivo"><input id="file" type="file" class="hidden" multiple>📎</label>
              </div>
            </div>
            <div id="dropzone" class="drop">Arraste arquivos/links aqui • URLs serão lidas pelo servidor</div>
          </div>
          <button class="send" type="submit">Enviar</button>
        </form>
      </footer>
    </main>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal" style="display:none; align-items:center; justify-content:center; position:fixed; inset:0; background:rgba(5,8,18,.6)">
    <div class="panel" style="width:min(760px,92vw)">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><h2 style="margin:0">Configurações</h2><button class="btn" id="btn-close">Fechar</button></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="field"><label>Endpoint do servidor (Vercel)</label><input id="server-url" placeholder="/api/ask" value="/api/ask" /></div>
        <div class="field"><label>Modelo (server-side)</label><input id="model" placeholder="gpt-5" value="gpt-5" /></div>
        <div class="field"><label>Idioma preferido</label><select id="lang"><option value="pt-BR" selected>Português (Brasil)</option><option value="en">English</option></select></div>
        <div class="field"><label>Voz (TTS do navegador)</label><select id="voice"></select></div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin-top:10px"><button class="btn" id="btn-ping">Testar conexão</button><span id="ping-result" style="color:#cfd1ff"></span></div>
    </div>
  </div>

  <script>
    // ==================== STATE ====================
    const state = {
      server: localStorage.getItem('nx.server') || '/api/ask',
      model: localStorage.getItem('nx.model') || 'gpt-5',
      lang: localStorage.getItem('nx.lang') || 'pt-BR',
      tools: { web:true, news:false, wiki:true, youtube:false, files:false, sheets:false, maxWeb:Number(localStorage.getItem('nx.maxWeb')||6), depth:localStorage.getItem('nx.depth')||'balanced' },
      messages: JSON.parse(localStorage.getItem('nx.thread')||'[]'),
      busy:false
    };
    const $ = s=>document.querySelector(s);
    const chat = $('#chat'); const promptEl=$('#prompt'); const urlEl=$('#page-url'); const fileEl=$('#file'); const drop=$('#dropzone');

    function save(){ localStorage.setItem('nx.server', state.server); localStorage.setItem('nx.model', state.model); localStorage.setItem('nx.lang', state.lang); localStorage.setItem('nx.maxWeb', String(state.tools.maxWeb)); localStorage.setItem('nx.depth', state.tools.depth); localStorage.setItem('nx.thread', JSON.stringify(state.messages)); }

    function el(tag, attrs={}, children=[]){ const e=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>{ if(k==='class') e.className=v; else if(k==='html') e.innerHTML=v; else e.setAttribute(k,v); }); children.forEach(c=>e.appendChild(c)); return e; }

    function message(role, content){
      const avatar = el('div',{class:'avatar '+(role==='user'?'user':'')},[el('span',{html: role==='user'?'U':'IA'})]);
      const bubble = el('div',{class:'bubble'}); bubble.appendChild(renderMarkdown(content||''));
      const msg = el('div',{class:'msg'},[avatar,bubble]); chat.appendChild(msg); chat.scrollTop = chat.scrollHeight; return bubble;
    }

    function renderMarkdown(text){
      const box=document.createElement('div');
      text=(text||'').replace(/[&<>]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]));
      text=text.replace(/```([\s\S]*?)```/g,(m,c)=>`<pre><code>${c}</code></pre>`);
      text=text.replace(/`([^`]+)`/g,'<code>$1</code>');
      text=text.replace(/\*\*([^*]+)\*\*/g,'<b>$1</b>');
      text=text.replace(/(https?:\/\/[^\s)]+)(?![^<]*>|[^<>]*<\/)/g,'<a href="$1" target="_blank" rel="noreferrer noopener">$1</a>');
      text=text.split(/\n\n+/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join(''); box.innerHTML=text; return box;
    }
    function webCards(items){ const wrap=el('div',{class:'web-results'}); items.forEach(r=>{ const a=el('a',{href:r.url,target:'_blank',rel:'noreferrer noopener'}); const card=el('div',{class:'result'}); card.append(el('h4',{html:r.title||r.url}), el('div',{class:'meta',html:`${(new URL(r.url)).hostname} • ${r.date||''}`}), el('div',{class:'snippet',html:r.snippet||''})); a.appendChild(card); wrap.appendChild(a); }); return wrap; }

    // ======= STATUS & BANNERS =======
    async function checkServer(){
      $('#status-chip').textContent = 'Verificando servidor…';
      try{ const r=await fetch(state.server+'?ping=1'); if(r.ok){ $('#status-chip').textContent='Servidor OK'; showOk('Servidor conectado.'); } else { $('#status-chip').textContent='Servidor falhou'; showErr('Falha no ping: '+r.status); } }
      catch(e){ $('#status-chip').textContent='Sem conexão'; showErr('Erro de rede: '+(e?.message||e)); }
    }
    function showOk(t){ const b=$('#banner-ok'); b.textContent='✅ '+t; b.classList.add('show'); setTimeout(()=>b.classList.remove('show'), 3000); }
    function showErr(t){ const b=$('#banner-err'); b.textContent='⚠️ '+t; b.classList.add('show'); setTimeout(()=>b.classList.remove('show'), 6000); }

    // ======= TTS =======
    let voices=[]; function loadVoices(){ voices = window.speechSynthesis?window.speechSynthesis.getVoices():[]; const sel=$('#voice'); if(!sel) return; sel.innerHTML=''; voices.forEach((v,i)=>{ const o=el('option',{value:i,html:`${v.name} (${v.lang})`}); if(v.lang.startsWith(state.lang)) o.selected=true; sel.appendChild(o); }); }
    if('speechSynthesis' in window){ window.speechSynthesis.onvoiceschanged=loadVoices; loadVoices(); }
    $('#btn-tts').onclick=()=>{ const last=[...document.querySelectorAll('.bubble')].pop(); if(!last) return; const u=new SpeechSynthesisUtterance(last.innerText.slice(0,8000)); const v=voices[$('#voice')?.value|0]; if(v) u.voice=v; u.lang=state.lang; window.speechSynthesis.speak(u); };

    // ======= MIC =======
    let rec, listening=false; $('#btn-mic').onclick=()=>{ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR) return alert('Reconhecimento de voz não suportado.'); if(!rec){ rec=new SR(); rec.lang=state.lang; rec.interimResults=true; rec.continuous=false; } if(listening){ rec.stop(); return; } listening=true; $('#btn-mic').style.boxShadow='0 0 16px rgba(0,229,255,.45)'; rec.start(); rec.onresult=e=>{ const t=Array.from(e.results).map(r=>r[0].transcript).join(''); promptEl.value=t; }; rec.onend=()=>{ listening=false; $('#btn-mic').style.boxShadow='none'; }; };

    // ======= Sidebar binds =======
    ['web','news','wiki','youtube','files','sheets'].forEach(k=>{ const elc=$('#cap-'+k); if(elc) { elc.checked=state.tools[k]; elc.onchange=e=> state.tools[k]=e.target.checked; } });
    $('#max-web').value=state.tools.maxWeb; $('#web-depth').value=state.tools.depth; $('#max-web').oninput=e=> state.tools.maxWeb=Number(e.target.value); $('#web-depth').oninput=e=> state.tools.depth=e.target.value;

    // ======= Modal =======
    const modal=$('#modal'); $('#btn-settings').onclick=()=>{ $('#server-url').value=state.server; $('#model').value=state.model; $('#lang').value=state.lang; modal.style.display='flex'; }; $('#btn-close').onclick=()=> modal.style.display='none';
    $('#server-url').onchange=e=> state.server=e.target.value||'/api/ask'; $('#model').onchange=e=> state.model=e.target.value||'gpt-5'; $('#lang').onchange=e=> state.lang=e.target.value||'pt-BR';
    $('#btn-ping').onclick=checkServer;

    // ======= Quick templates =======
    $('#quick').addEventListener('click', e=>{ const b=e.target.closest('button.q'); if(!b) return; promptEl.value=b.dataset.template||''; promptEl.focus(); });

    // ======= Export / Clear =======
    $('#btn-export').onclick=()=>{ const blob=new Blob([JSON.stringify({createdAt:new Date().toISOString(),messages:state.messages},null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=el('a',{href:url,download:'nexus-thread.json'}); document.body.appendChild(a); a.click(); a.remove(); };
    $('#btn-clear').onclick=()=>{ if(confirm('Limpar conversa atual?')){ state.messages=[]; chat.innerHTML=''; save(); } };

    // ======= Drag & Drop =======
    ;['dragenter','dragover','dragleave','drop'].forEach(evt=>drop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); }));
    drop.addEventListener('drop', e=>{ const dt=e.dataTransfer; if(!dt) return; const u=dt.getData('text/uri-list')||dt.getData('text/plain'); if(u && /^https?:\/\//.test(u)){ urlEl.value=u; return; } if(dt.files && dt.files.length){ fileEl.files=dt.files; } });

    // ==================== SEND ====================
    $('#ask-form').addEventListener('submit', async e=>{
      e.preventDefault(); if(state.busy) return; state.busy=true;
      const content=promptEl.value.trim(); if(!content){ state.busy=false; return; }
      const url=(urlEl.value||'').trim(); const files=fileEl.files?Array.from(fileEl.files):[];

      message('user', content + (url? `\n\nURL: ${url}`:''));
      state.messages.push({role:'user', content, url}); save();

      const bubble=message('assistant', 'Gerando resposta <span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>');
      let streamingText=''; let gotAny=false; let watchdog;

      try{
        const payload={ model:state.model, messages:state.messages, tools:{...state.tools, lang:state.lang}, url:url||null };
        let res; if(files.length){ const form=new FormData(); form.append('payload', new Blob([JSON.stringify(payload)],{type:'application/json'})); files.forEach((f,i)=> form.append('file'+i, f)); res=await fetch(state.server,{method:'POST', body:form}); } else { res=await fetch(state.server,{method:'POST', headers:{'Content-Type':'application/json','Accept':'text/event-stream'}, body:JSON.stringify(payload)}); }

        const ctype=(res.headers.get('content-type')||'').toLowerCase();
        const startWatch=()=>{clearTimeout(watchdog); watchdog=setTimeout(()=>{ if(!gotAny){ showErr('Sem dados do servidor. Confira se /api/ask está em streaming SSE e se a OPENAI_API_KEY está válida.'); } }, 6000); };

        if(ctype.includes('text/event-stream') || (res.body && res.body.getReader)){
          const reader=res.body.getReader(); const decoder=new TextDecoder(); let buffer=''; startWatch();
          while(true){ const {done, value}=await reader.read(); if(done) break; gotAny=true; buffer+=decoder.decode(value,{stream:true}); const parts=buffer.split(/\n\n/); buffer=parts.pop(); for(const part of parts){ const lines=part.split(/\n/).filter(Boolean); for(const line of lines){ if(line.startsWith('data:')){ const data=line.slice(5).trim(); try{ const j=JSON.parse(data); if(j.type==='web_results' && Array.isArray(j.items)){ bubble.appendChild(webCards(j.items)); } else if(j.type==='done'){ /* ignore */ } else if(j.delta){ streamingText+=j.delta; bubble.innerHTML=''; bubble.appendChild(renderMarkdown(streamingText)); } } catch{ streamingText+=data; bubble.innerHTML=''; bubble.appendChild(renderMarkdown(streamingText)); } } } chat.scrollTop=chat.scrollHeight; } }
        else if(ctype.includes('application/json')){ const j=await res.json(); streamingText=j.answer||JSON.stringify(j); bubble.innerHTML=''; bubble.appendChild(renderMarkdown(streamingText||'(vazio)')); if(Array.isArray(j.web_results)&&j.web_results.length){ bubble.appendChild(webCards(j.web_results)); } }
        else { const text=await res.text(); streamingText=text; bubble.innerHTML=''; bubble.appendChild(renderMarkdown(text)); }

        state.messages.push({role:'assistant', content:streamingText}); save(); showOk('Resposta recebida.');
      } catch(err){ bubble.innerHTML=''; bubble.appendChild(renderMarkdown('⚠️ **Erro** ao consultar o servidor:** '+(err?.message||err))); showErr('Erro: '+(err?.message||err)); }
      finally{ clearTimeout(watchdog); state.busy=false; promptEl.value=''; urlEl.value=''; fileEl.value=''; }
    });

    // Bootstrap
    if(state.messages.length===0){ message('assistant', 'Olá! Eu sou a **Nexus Web IA** estilo **Sci‑Fi HUD**. Posso pesquisar na web, ler páginas/PDFs e usar seu backend seguro (**/api/ask**). Ative os recursos ao lado e envie sua primeira pergunta.'); }
    else { state.messages.forEach(m=> message(m.role, m.content)); }

    $('#prompt').addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $('#ask-form').requestSubmit(); } });
    window.addEventListener('beforeunload', save);

    // Teste inicial de servidor
    checkServer();
  </script>
</body>
</html>
